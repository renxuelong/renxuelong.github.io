<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon_normal.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon_small.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Android,源码解析,Binder,AIDL," />










<meta name="description" content="一、Binder简析直观来说，Binder 是 Android 中的一个类，是继承了 IBinder 接口；从 IPC 角度考虑 Binder 是进程间通信的一种方式；从 Framework 层，Binder 是 ServiceManager  用来连接各种 Manager(AM,WM) 和各种 ManagerService 的桥梁；从应用层来说，Binder 是客户端和服务器端进行通信的媒介，当">
<meta name="keywords" content="Android,源码解析,Binder,AIDL">
<meta property="og:type" content="article">
<meta property="og:title" content="Android中的Binder与AIDL">
<meta property="og:url" content="http://renxuelong.com/2018/11/29/Android中的Binder与AIDL/index.html">
<meta property="og:site_name" content="任雪龙的博客">
<meta property="og:description" content="一、Binder简析直观来说，Binder 是 Android 中的一个类，是继承了 IBinder 接口；从 IPC 角度考虑 Binder 是进程间通信的一种方式；从 Framework 层，Binder 是 ServiceManager  用来连接各种 Manager(AM,WM) 和各种 ManagerService 的桥梁；从应用层来说，Binder 是客户端和服务器端进行通信的媒介，当">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-11-29T03:06:24.377Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android中的Binder与AIDL">
<meta name="twitter:description" content="一、Binder简析直观来说，Binder 是 Android 中的一个类，是继承了 IBinder 接口；从 IPC 角度考虑 Binder 是进程间通信的一种方式；从 Framework 层，Binder 是 ServiceManager  用来连接各种 Manager(AM,WM) 和各种 ManagerService 的桥梁；从应用层来说，Binder 是客户端和服务器端进行通信的媒介，当">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://renxuelong.com/2018/11/29/Android中的Binder与AIDL/"/>





  <title>Android中的Binder与AIDL | 任雪龙的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">任雪龙的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://renxuelong.com/2018/11/29/Android中的Binder与AIDL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="任雪龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="任雪龙的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android中的Binder与AIDL</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-29T11:04:51+08:00">
                2018-11-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Andriod源码/" itemprop="url" rel="index">
                    <span itemprop="name">Andriod源码</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/29/Android中的Binder与AIDL/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/29/Android中的Binder与AIDL/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="一、Binder简析"><a href="#一、Binder简析" class="headerlink" title="一、Binder简析"></a>一、Binder简析</h2><p>直观来说，Binder 是 Android 中的一个类，是继承了 IBinder 接口；从 IPC 角度考虑 Binder 是进程间通信的一种方式；从 Framework 层，Binder 是 ServiceManager  用来连接各种 Manager(AM,WM) 和各种 ManagerService 的桥梁；从应用层来说，Binder 是客户端和服务器端进行通信的媒介，当 bindService 的时候服务器端会返回一个包含了服务端业务调用的 Binder 对象，客户端就可以获取服务端提供的数据或服务。</p>
<a id="more"></a>
<h3 id="1-1-为什么要使用-Binder-来进行进程间通信"><a href="#1-1-为什么要使用-Binder-来进行进程间通信" class="headerlink" title="1.1 为什么要使用 Binder 来进行进程间通信"></a>1.1 为什么要使用 Binder 来进行进程间通信</h3><ol>
<li>传统进程间通信机制如 Socket 开销较大且效率不高</li>
<li>管道和队列拷贝次数太多</li>
<li>移动设备的安全性，传统通信机制安全新低，大部分情况接收方无法得到发送方进行的 PID/UID，难以进行身份验证</li>
<li>binder 在设计时就考虑到了以上的问题，在保证效率的同时也提高了安全性</li>
</ol>
<h2 id="二、Binder-在应用层的使用-AIDL"><a href="#二、Binder-在应用层的使用-AIDL" class="headerlink" title="二、Binder 在应用层的使用 - AIDL"></a>二、Binder 在应用层的使用 - AIDL</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This file is auto-generated.  DO NOT MODIFY.</span></span><br><span class="line"><span class="comment"> * Original file: D:\\MyApplication\\ServiceDemo\\app\\src\\main\\aidl\\com\\renxl\\servicedemo\\aidl\\MyWorker.aidl</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">package</span> com.renxl.servicedemo.aidl;</span><br><span class="line"><span class="comment">// Declare any non-default types here with import statements</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyWorker</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">IInterface</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Local-side IPC implementation stub class.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">renxl</span>.<span class="title">servicedemo</span>.<span class="title">aidl</span>.<span class="title">MyWorker</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.lang.String DESCRIPTOR = <span class="string">"com.renxl.servicedemo.aidl.MyWorker"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Construct the stub at attach it to the interface.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Stub</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.attachInterface(<span class="keyword">this</span>, DESCRIPTOR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Cast an IBinder object into an com.renxl.servicedemo.aidl.MyWorker interface,</span></span><br><span class="line"><span class="comment">         * generating a proxy if needed.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> com.renxl.servicedemo.aidl.<span class="function">MyWorker <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ((obj == <span class="keyword">null</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR);</span><br><span class="line">            <span class="keyword">if</span> (((iin != <span class="keyword">null</span>) &amp;&amp; (iin <span class="keyword">instanceof</span> com.renxl.servicedemo.aidl.MyWorker))) &#123;</span><br><span class="line">                <span class="keyword">return</span> ((com.renxl.servicedemo.aidl.MyWorker) iin);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> com.renxl.servicedemo.aidl.MyWorker.Stub.Proxy(obj);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">                <span class="keyword">case</span> INTERFACE_TRANSACTION: &#123;</span><br><span class="line">                    reply.writeString(DESCRIPTOR);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> TRANSACTION_doWork: &#123;</span><br><span class="line">                    data.enforceInterface(DESCRIPTOR);</span><br><span class="line">                    java.lang.String _arg0;</span><br><span class="line">                    _arg0 = data.readString();</span><br><span class="line">                    <span class="keyword">int</span> _result = <span class="keyword">this</span>.doWork(_arg0);</span><br><span class="line">                    reply.writeNoException();</span><br><span class="line">                    reply.writeInt(_result);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">renxl</span>.<span class="title">servicedemo</span>.<span class="title">aidl</span>.<span class="title">MyWorker</span> </span>&#123;</span><br><span class="line">            <span class="keyword">private</span> android.os.IBinder mRemote;</span><br><span class="line"></span><br><span class="line">            Proxy(android.os.IBinder remote) &#123;</span><br><span class="line">                mRemote = remote;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> mRemote;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> java.lang.<span class="function">String <span class="title">getInterfaceDescriptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> DESCRIPTOR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">doWork</span><span class="params">(java.lang.String str)</span> <span class="keyword">throws</span> android.os.RemoteException </span>&#123;</span><br><span class="line">                android.os.Parcel _data = android.os.Parcel.obtain();</span><br><span class="line">                android.os.Parcel _reply = android.os.Parcel.obtain();</span><br><span class="line">                <span class="keyword">int</span> _result;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">                    _data.writeString(str);</span><br><span class="line">                    mRemote.transact(Stub.TRANSACTION_doWork, _data, _reply, <span class="number">0</span>);</span><br><span class="line">                    _reply.readException();</span><br><span class="line">                    _result = _reply.readInt();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    _reply.recycle();</span><br><span class="line">                    _data.recycle();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> _result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_doWork = (android.os.IBinder.FIRST_CALL_TRANSACTION + <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">doWork</span><span class="params">(java.lang.String str)</span> <span class="keyword">throws</span> android.os.RemoteException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-1-介绍"><a href="#2-1-介绍" class="headerlink" title="2.1 介绍"></a>2.1 介绍</h3><p>我们自定义的 AIDL 数据类继承 IInterface 接口，因为可以在 Binder 中传输的数据都需要继承 IInterface 并实现其 asBinder 方法</p>
<p>Stub 是 AIDL 接口中的抽象类，Stub 类继承了 Binder 和我们需要在进程中传递的数据类型接口，Stub 类中还有 Proxy 子类，该类也继承了需要在进程间传递的数据类型</p>
<h3 id="2-2-服务端的返回值"><a href="#2-2-服务端的返回值" class="headerlink" title="2.2 服务端的返回值"></a>2.2 服务端的返回值</h3><p>从客户端通过绑定形式启动 Service 时服务端返回的客户端所需的 AIDL 接口类型的对象入手，开发中服务端返回的 Binder 对象的类继承了 AIDL 中内部类 Stub 类，因为 Java 中多态的存在，我们需要 IBinder 对象时返回 IBinder 的子类即可。说一下为什么 服务端 返回的是 AIDL 中的内部类 Stub 类的对象的子类，因为，该抽象类的子类实现了我们定义的 .aidl 接口中的方法，所以返回的应该是这个 Stub 类的子类。Stub 子类实现了 .aidl 中声明的方法的抽象方法。</p>
<p>服务端 Stub 的子类实例化时，因为同时是 Binder 的子类，会调用 Binder 的 attachInterface 方法，将本身和 IInterface 的描述字符串添加到 Binder 类中，Binder 类中会根据描述字符串匹配保存当前的 Binder 对象。</p>
<h3 id="2-3-进程间通信时客户端工作流程"><a href="#2-3-进程间通信时客户端工作流程" class="headerlink" title="2.3 进程间通信时客户端工作流程"></a>2.3 进程间通信时客户端工作流程</h3><p>根据绑定模式的 Service 绑定过程，最终服务端返回的 Binder 对象会传递到客户端的 ServiceConnection 的 onServiceConnected 方法中。</p>
<p>客户端得到服务端返回的 Binder 后，会通过自定义 AIDL 接口类的 asInterface 将该 Binder 转化为客户端需要的接口类型对象，asInterface 方法会从 Binder 类中根据描述字符串寻找相应的 IInterface，客户端和服务端不在同一进程时，由于 Binder 类的加载也是分开的，所以在客户端的 Binder 中不会找到匹配的 IInterface </p>
<p>在同进程请求时 asInterface 返回的是 Stub 的实现类的对象，也就是直接返回了服务端返回的继承了 Stub 类的对象。同进程不用考虑 Binder 传输数据，所以直接调用 Stub 实现类的各种方法即可实现客户端调用服务端的数据和服务的功能。</p>
<p>在跨进程调用时，由于客户端 Binder 中不能找到对应的 IInterface，所以 asInterface 中返回的是根据 Stub 的子类对象构造的 Stub.Proxy 类的对象。Stub.Proxy 类中调用服务器端方法时会将参数和返回值都使用序列化处理，经过跨进程通信后最终将结果返回到客户端。从而完成客户端调用服务端服务和数据的功能。</p>
<h5 id="为什么服务器端返回的-Binder-是客户端需要的类对象，但是跨进程时需要转换为-Proxy-？"><a href="#为什么服务器端返回的-Binder-是客户端需要的类对象，但是跨进程时需要转换为-Proxy-？" class="headerlink" title="为什么服务器端返回的 Binder 是客户端需要的类对象，但是跨进程时需要转换为 Proxy ？"></a>为什么服务器端返回的 Binder 是客户端需要的类对象，但是跨进程时需要转换为 Proxy ？</h5><p>因为不同进程间的对象不能相互调用，虽然绑定完成时客户端拿到了服务器端对象的引用但是并不能直接操作该对象，所以需要通过 Proxy 来代理，Proxy 类的方法执行时会在 Native 层通过系统进程的协助调用服务端对象来执行任务，所以跨进程时客户端拿到的 Binder 对象不可以直接强制转型为需要的对象。</p>
<h3 id="2-4-进程间通信时服务端的工作流程"><a href="#2-4-进程间通信时服务端的工作流程" class="headerlink" title="2.4 进程间通信时服务端的工作流程"></a>2.4 进程间通信时服务端的工作流程</h3><p>跨进程调用时客户端的调用逻辑：上面说了跨进程时得到的AIDL接口数据类型是 Stub.Proxy ，所以直接分析 Stub.Proxy 类中的方法调用。Stub.Proxy 中调用方法并不会直接调用服务端的方法，会先创建 Parcel 类型的输入对象和输出对象以及返回值。如果方法有参数就将参数写入输入型 Parcel 对象中,这个过程还是在客户端，接下来会将序列化后的参数，序列化的返回值，以及表示客户端调用的是哪个方法的 int 值传入 Binder 的 transact 方法，客户端线程挂起。</p>
<p>Binder 的 transact 方法中会调用 Native 层的方法，Native 层会根据 IInterface 描述字符串从系统中所有进程的 Binder 中找到客户端 Proxy 对应的服务器端的 IInterface ，然后通过其 asBinder 方法得到服务器端的 Binder 对象也就是 Stub 对象，再通过调用其 onTransact 方法执行客户端指定的操作。这个过程由系统进程负责将客户端跟服务端连接。</p>
<p>说一下这个 Binder ， 创建 Proxy 时构造方法传入的 IBinder 也就是客户端绑定时得到的 Binder 类对象，通过系统进程调用服务端的 onTransact 方法，执行也就切换到了服务端，服务端也就拿到了序列化后的参数，返回值以及代表哪个方法的 int 值。transact 方法中会把存储参数和返回值的可序列化数据传递到 onTransact 方法中</p>
<p>onTransact 方法中会将序列化的参数反序列化，再根据代表客户端调用哪个方法的 int 值，将参数传入相应方法得到返回值。 <strong>这里需要注意，传入相应的方法，其实是调用的 Stub 类的子类的方法，也就是服务端实现了 Stub 类中抽象方法的那个类的对象的方法，这样最终任务的执行是在 Stub 中执行的，并不是在 Proxy 类中。</strong> 再将返回值进行序列化后写入参数中传来的输出型 Parcel 中，这时候，注意，服务端就执行结束了。</p>
<p>服务端执行结束之后，系统进程会返回一个 Boolean 值表示是否成功调用，系统进程收到这个返回值时后将该返回值和及 将输出型的 Pacel  返回到客户端进程，客户端进程的 Binder 线程会被唤醒，客户端线程唤醒后，会根据是否执行成功的返回值接收执行结果</p>
<p><strong>注：</strong></p>
<ol>
<li><p>客户端发起请求时当前线程就会挂起，所以要是执行任务耗时则需要客户端在子线程中调用</p>
</li>
<li><p>服务端相应请求执行过程在 Binder 的线程池中，即已经在子线程中了，所有 Binder 中执行过程无需再开启子线程</p>
</li>
</ol>
<h2 id="三、Binder-的死亡代理"><a href="#三、Binder-的死亡代理" class="headerlink" title="三、Binder 的死亡代理"></a>三、Binder 的死亡代理</h2><p>通过 linkToDeath 和 unlinkToDeath 方法可以在客户端为 Binder 绑定和解绑死亡代理<br>死亡代理是一个 DeathRecipient 类，内部又一个 binderDied 方法，我们需要实现这个方法，在 Binder 死亡的时候，系统就会回调 binderDied 方法，我们就可以移除之前绑定的 binder 代理并重新绑定完成服务。</p>
<h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><ul>
<li><p>Worker：需要传递的对象需要实现的接口，继承 IInterface 接口</p>
</li>
<li><p>Stub：服务器端需要实现的对象的父类继承 Binder 类</p>
</li>
<li><p>Proxy：代理类，客户端调用服务器端对象时使用的类 </p>
</li>
</ul>
<p>当 Stub 的子类实例化时，Binder 中会存起来，并将该 Binder 返回到客户端，客户端拿到这个 Binder 会根据是否是同进程操作，不同进程时会通过 Binder 构造</p>
<h4 id="4-1-AIDL原理"><a href="#4-1-AIDL原理" class="headerlink" title="4.1 AIDL原理"></a>4.1 AIDL原理</h4><p>Binder 在 AIDL 中应用，服务器端将客户端需要的对象转换成一个 Binder 对象</p>
<p>AIDL 原理，即客户端需要一个服务器端的对象，客户端和服务器端不在同一进程，服务端返回一个 Binder 对象给客户端，客户端根据将 Binder 对象转换成需要的对象的 Proxy 代理，需要调用服务端执行任务时就调用该 Proxy 代理的方法，Proxy 代理的方法执行时会通过 Native 层通过系统进程找到其他进程中匹配的 Stub 子类，并调用其执行任务方法，从而实现客户端和服务端的进程间通信。</p>
<h3 id="4-2-AIDL-工作过程"><a href="#4-2-AIDL-工作过程" class="headerlink" title="4.2 AIDL 工作过程"></a>4.2 AIDL 工作过程</h3><p>首先，我们服务器端有一个可以执行任务的对象需要传递到客户端，然而不同进程之间不可以直接调用对象的方法，从而通过 Binder 来实现进程间的通信。</p>
<ol start="0">
<li><p><strong>aidl文件</strong> 定义 .aidl 类型文件,其中声明要实现的功能方法</p>
</li>
<li><p><strong>定义接口</strong> 首先，定义 AIDL 类型的接口，也就是需要传递的对象类型接口，继承 IInterface ，并在其中根据 aidl 文件的内容定义了这个类的可以实现功能的抽象方法</p>
</li>
<li><p><strong>接口中定义内部类 Stub</strong> 在接口中定义 Stub 类，该类实现了我们需要的接口，并继承了 Binder</p>
</li>
<li><p><strong>服务端实现接口</strong> 服务端要定义类实现 Stub 类，然后完成我们自己定义的接口的抽象方法</p>
</li>
<li><p><strong>Stub 类的实现</strong> Stub 类中定义了 asInterface 可以返回一个我们需要的类对象，如果是同进程则返回本身，如果是非同进程则返回 Stub 的内部类 <strong>Proxy 代理类对象</strong></p>
</li>
<li><p><strong>客户端请求</strong> 客户端绑定时服务器返回服务端实现的接口类型的对象，客户端得到的 Binder 对象就是 Stub 对象，客户端调用 Stub 对象的 asInterface 方法得到需要的类型对象</p>
</li>
<li><p><strong>同进程对象工作</strong> 客户端得到需要的对象后，调用其方法，如果是同进程，参数可以直接传递，同时 asInterface 得到的就是服务端实现的 Stub 对象，可以直接执行方法返回结果</p>
</li>
<li><p><strong>跨进程对象工作</strong> 如果是跨进程时，asInterface 得到的就是 Stub 的内部类 Proxy 类的对象，该对象继承了我们需要的接口，并实现了其抽象方法，Proxy 的构造需要一个 Stub 类对象</p>
</li>
<li><p><strong>Proxy 的工作过程</strong> 其实现的抽象方法执行时，会先将方法参数序列化，再调用 Stub 方法的 transact 方法将序列化后的参数，方法 int 类型的标识传入，线程挂起，服务端在 Binder 线程中执行任务后将序列化后的结果返回。Proxy 的工作方法中，得到结果后，将序列化后的结果反序列化成方法的返回值类型，返回。</p>
</li>
<li><p><strong>transact 方法</strong> transact 方法最后会调用 Stub 的 onTransact 方法</p>
</li>
<li><p><strong>Stub 的 onTransact 方法</strong> onTransact 方法执行在服务器进程的 Binder 线程池中，根据方法标识，将序列化后的参数反序列化，在服务端执行，得到返回值后序列化，最后将结果返回，传回到客户端。客户端处理后完成。</p>
</li>
</ol>
<h3 id="4-3-Binder-机制在系统中的应用"><a href="#4-3-Binder-机制在系统中的应用" class="headerlink" title="4.3 Binder 机制在系统中的应用"></a>4.3 Binder 机制在系统中的应用</h3><p>Android 系统启动之后会启动很多的 Service，例如 ActivityManagerService 等，在开发中我们可能需要调用这些 Service 的方法，但是由于是不同进程是不可以直接调用的，这时候我们在 ServiceManager 中通过 Binder 机制跨进程拿到 AMS 的代理 ActivityManagerProxy，通过代理即可实现调用 AMS 的方法。</p>
<p>上面提到了 ServiceManager，那 ServiceManager 又是怎么工作的呢，ServiceManager 其实是 ServiceManagerProxy 的代理，ServiceManagerProxy 是 ServiceManagerNative 的代理，ServiceManagerNative 继承了 IServiceManager 并运行在系统进程 ，我们看出来了，原来 ServiceManager 也是通过 Binder 实现跨进程的</p>
<p>我们在应用中使用 ServiceManager 在获取系统服务时，如果 ServiceManager 代理的 ServiceManagerNative 没有初始化，则会通过 Natice 层来通过 Binder 机制完成 ServiceManagerNative 初始化，此时的服务端是系统进程，之后我们就可以使用 ServiceManager 来协助我们获取其他的系统服务了。ServiceManager 在这里实现了 Binder 连接池的作用。同一个一个池对象，我们可以获得多个 Binder 对象。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
            <a href="/tags/源码解析/" rel="tag"># 源码解析</a>
          
            <a href="/tags/Binder/" rel="tag"># Binder</a>
          
            <a href="/tags/AIDL/" rel="tag"># AIDL</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/11/28/Android中的Window和WindowManagerService/" rel="next" title="Android中的Window和WindowManagerService">
                <i class="fa fa-chevron-left"></i> Android中的Window和WindowManagerService
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_fav">收藏夹</a>
<a class="jiathis_button_copy">复制网址</a>
<a class="jiathis_button_email">邮件</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tqq">腾讯微博</a>
<a class="jiathis_button_douban">豆瓣</a>
<a class="jiathis_button_share">一键分享</a>

<a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
  data_track_clickback:true,
  summary:"",
  shortUrl:false,
  hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script>
<!-- JiaThis Button END -->
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="任雪龙" />
            
              <p class="site-author-name" itemprop="name">任雪龙</p>
              <p class="site-description motion-element" itemprop="description">Keep moving forward</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/renxuelong" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:renxuelongvip@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-globe"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、Binder简析"><span class="nav-number">1.</span> <span class="nav-text">一、Binder简析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-为什么要使用-Binder-来进行进程间通信"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 为什么要使用 Binder 来进行进程间通信</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、Binder-在应用层的使用-AIDL"><span class="nav-number">2.</span> <span class="nav-text">二、Binder 在应用层的使用 - AIDL</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-介绍"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-服务端的返回值"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 服务端的返回值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-进程间通信时客户端工作流程"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 进程间通信时客户端工作流程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#为什么服务器端返回的-Binder-是客户端需要的类对象，但是跨进程时需要转换为-Proxy-？"><span class="nav-number">2.3.0.1.</span> <span class="nav-text">为什么服务器端返回的 Binder 是客户端需要的类对象，但是跨进程时需要转换为 Proxy ？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-进程间通信时服务端的工作流程"><span class="nav-number">2.4.</span> <span class="nav-text">2.4 进程间通信时服务端的工作流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、Binder-的死亡代理"><span class="nav-number">3.</span> <span class="nav-text">三、Binder 的死亡代理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、总结"><span class="nav-number">4.</span> <span class="nav-text">四、总结</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-AIDL原理"><span class="nav-number">4.0.1.</span> <span class="nav-text">4.1 AIDL原理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-AIDL-工作过程"><span class="nav-number">4.1.</span> <span class="nav-text">4.2 AIDL 工作过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-Binder-机制在系统中的应用"><span class="nav-number">4.2.</span> <span class="nav-text">4.3 Binder 机制在系统中的应用</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">任雪龙</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://renxuelong.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://renxuelong.com/2018/11/29/Android中的Binder与AIDL/';
          this.page.identifier = '2018/11/29/Android中的Binder与AIDL/';
          this.page.title = 'Android中的Binder与AIDL';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://renxuelong.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  





  

  

  

  
  

  

  

  

</body>
</html>
